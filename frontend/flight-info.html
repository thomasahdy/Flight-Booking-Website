<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Information - Tripma</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <a href="../index.php" class="logo">Tripma</a>
            <ul class="nav-links" id="navLinks">
                <li><a href="search-flight.html">Flights</a></li>
                <li><a href="login.html">Sign in</a></li>
                <li><a href="register.html" class="btn btn-primary">Sign up</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="card" id="flightInfo">
            <p style="text-align: center;">Loading...</p>
        </div>

        <div id="bookingSection" style="margin-top: 2rem; display: none;">
            <div class="card">
                <h3>Book This Flight</h3>
                <p><strong>Price:</strong> <span id="price"></span></p>
                <p><strong>Your Balance:</strong> <span id="balance"></span></p>

                <div class="form-group">
                    <label>Payment Method:</label>
                    <select id="paymentType" class="form-control">
                        <option value="account">Pay from Account Balance</option>
                        <option value="cash">Cash (Pay at Company)</option>
                    </select>
                </div>

                <button onclick="bookFlight()" class="btn btn-primary">Book Flight</button>
                <button onclick="showMessageForm()" class="btn btn-secondary">Message Company</button>
            </div>
        </div>

        <div id="messageSection" style="margin-top: 2rem; display: none;">
            <div class="card">
                <h3>Message Company</h3>
                <textarea id="messageText" placeholder="Type your message..."
                    style="width: 100%; min-height: 100px; padding: 0.5rem;"></textarea>
                <button onclick="sendMessage()" class="btn btn-primary" style="margin-top: 1rem;">Send Message</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const flightId = new URLSearchParams(window.location.search).get('id');
        let flight = null;
        let user = getCurrentUser();

        // Update navigation based on user
        if (user) {
            const navLinks = document.getElementById('navLinks');
            if (user.type === 'passenger') {
                navLinks.innerHTML = `
                    <li><a href="passenger-home.html">Home</a></li>
                    <li><a href="search-flight.html">Search Flights</a></li>
                    <li><a href="passenger-profile.html">Profile</a></li>
                    <li><a href="messages.html">Messages</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                `;
            } else if (user.type === 'company') {
                navLinks.innerHTML = `
                    <li><a href="company-home.html">Home</a></li>
                    <li><a href="add-flight.html">Add Flight</a></li>
                    <li><a href="company-profile.html">Profile</a></li>
                    <li><a href="messages.html">Messages</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                `;
            }
        }

        async function loadFlight() {
            const result = await apiCall('flights/get-flight-details.php?id=' + flightId);
            if (result.success) {
                flight = result.flight;
                displayFlight();

                if (user && user.type === 'passenger') {
                    document.getElementById('bookingSection').style.display = 'block';
                    loadBalance();
                }
            } else {
                alert('Flight not found');
                window.location.href = 'search-flight.html';
            }
        }

        function displayFlight() {
            document.getElementById('flightInfo').innerHTML = `
                <h2>${flight.flight_name}</h2>
                <p><strong>Flight ID:</strong> ${flight.flight_id}</p>
                <p><strong>Company:</strong> ${flight.company_name}</p>
                <p><strong>Email:</strong> ${flight.company_email}</p>
                <p><strong>Phone:</strong> ${flight.company_tel}</p>
                <p><strong>Itinerary:</strong> ${flight.itinerary}</p>
                <p><strong>Departure:</strong> ${formatDate(flight.start_date)} at ${formatTime(flight.start_time)}</p>
                <p><strong>Arrival:</strong> ${formatDate(flight.end_date)} at ${formatTime(flight.end_time)}</p>
                <p><strong>Price:</strong> ${formatCurrency(flight.fees)}</p>
                <p><strong>Available Seats:</strong> ${flight.available_seats}/${flight.max_passengers}</p>
                <p><strong>Status:</strong> <span class="badge badge-${flight.status === 'active' ? 'success' : 'warning'}">${flight.status}</span></p>
            `;
            document.getElementById('price').textContent = formatCurrency(flight.fees);
        }

        async function loadBalance() {
            const result = await apiCall('payments/get-balance.php');
            if (result.success) {
                document.getElementById('balance').textContent = formatCurrency(result.balance);
            }
        }

        async function bookFlight() {
            if (!user) {
                alert('Please login to book a flight');
                window.location.href = 'login.html';
                return;
            }

            const paymentType = document.getElementById('paymentType').value;

            if (paymentType === 'account') {
                const balance = await apiCall('payments/get-balance.php');
                if (balance.success && parseFloat(balance.balance) < parseFloat(flight.fees)) {
                    alert('Insufficient balance. Please choose cash payment or add funds to your account.');
                    return;
                }
            }

            const result = await apiCall('bookings/book-flight.php', 'POST', {
                flight_id: flightId,
                payment_type: paymentType
            });

            if (result.success) {
                alert('Flight booked successfully!');
                window.location.href = 'passenger-home.html';
            } else {
                alert('Error: ' + result.message);
            }
        }

        function showMessageForm() {
            document.getElementById('messageSection').style.display = 'block';
        }

        async function sendMessage() {
            if (!user) {
                alert('Please login to send messages');
                return;
            }

            const message = document.getElementById('messageText').value;
            if (!message) {
                alert('Please enter a message');
                return;
            }

            const result = await apiCall('messages/send-message.php', 'POST', {
                receiver_id: flight.company_user_id,
                flight_id: flightId,
                message: message
            });

            if (result.success) {
                alert('Message sent!');
                document.getElementById('messageText').value = '';
            } else {
                alert('Error: ' + result.message);
            }
        }

        loadFlight();
    </script>
</body>

</html>