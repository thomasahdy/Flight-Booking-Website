<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Details - Tripma</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <a href="company-home.html" class="logo">Tripma</a>
            <ul class="nav-links">
                <li><a href="company-home.html">Home</a></li>
                <li><a href="add-flight.html">Add Flight</a></li>
                <li><a href="company-profile.html">Profile</a></li>
                <li><a href="messages.html">Messages</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="card" id="flightDetails">
            <p style="text-align: center;">Loading...</p>
        </div>

        <section class="section">
            <div class="section-header">
                <h2>Registered Passengers (<span id="registeredCount">0</span>)</h2>
            </div>
            <div class="table-container" id="registeredPassengers">
                <p>Loading...</p>
            </div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2>Pending Passengers (<span id="pendingCount">0</span>)</h2>
            </div>
            <div class="table-container" id="pendingPassengers">
                <p>Loading...</p>
            </div>
        </section>

        <div style="margin-top: 2rem;">
            <button onclick="cancelFlight()" class="btn btn-secondary">Cancel Flight & Refund All</button>
            <a href="company-home.html" class="btn btn-primary">Back to Home</a>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        checkAuth('company');
        const flightId = new URLSearchParams(window.location.search).get('id');
        let flight = null;

        async function loadFlight() {
            const result = await apiCall('flights/get-flight-details.php?id=' + flightId);
            if (result.success) {
                flight = result.flight;
                displayFlight();
                displayPassengers();
            } else {
                alert('Flight not found');
                window.location.href = 'company-home.html';
            }
        }

        function displayFlight() {
            document.getElementById('flightDetails').innerHTML = `
                <h2>${flight.flight_name}</h2>
                <p><strong>Flight ID:</strong> ${flight.flight_id}</p>
                <p><strong>Itinerary:</strong> ${flight.itinerary}</p>
                <p><strong>Departure:</strong> ${formatDate(flight.start_date)} at ${formatTime(flight.start_time)}</p>
                <p><strong>Arrival:</strong> ${formatDate(flight.end_date)} at ${formatTime(flight.end_time)}</p>
                <p><strong>Fees:</strong> ${formatCurrency(flight.fees)}</p>
                <p><strong>Capacity:</strong> ${flight.max_passengers} passengers</p>
                <p><strong>Registered:</strong> ${flight.registered_passengers}</p>
                <p><strong>Pending:</strong> ${flight.pending_passengers}</p>
                <p><strong>Available:</strong> ${flight.available_seats}</p>
                <p><strong>Status:</strong> <span class="badge badge-${flight.status === 'active' ? 'success' : 'warning'}">${flight.status}</span></p>
            `;
        }

        function displayPassengers() {
            document.getElementById('registeredCount').textContent = flight.registered_passengers.length;
            document.getElementById('pendingCount').textContent = flight.pending_passengers_list.length;

            if (flight.registered_passengers.length > 0) {
                document.getElementById('registeredPassengers').innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Payment</th>
                                <th>Booked</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${flight.registered_passengers.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.email}</td>
                                    <td>${p.tel}</td>
                                    <td>${p.payment_type}</td>
                                    <td>${formatDate(p.booking_date)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('registeredPassengers').innerHTML = '<p>No registered passengers yet</p>';
            }

            if (flight.pending_passengers_list.length > 0) {
                document.getElementById('pendingPassengers').innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Payment</th>
                                <th>Booked</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${flight.pending_passengers_list.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.email}</td>
                                    <td>${p.tel}</td>
                                    <td>${p.payment_type}</td>
                                    <td>${formatDate(p.booking_date)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('pendingPassengers').innerHTML = '<p>No pending passengers</p>';
            }
        }

        async function cancelFlight() {
            if (!confirm('Are you sure you want to cancel this flight? All passengers will be refunded.')) {
                return;
            }

            const result = await apiCall('flights/cancel-flight.php', 'POST', { flight_id: flightId });
            if (result.success) {
                alert(`Flight cancelled! ${result.passengers_refunded} passengers refunded ${formatCurrency(result.refunded_amount)}`);
                window.location.href = 'company-home.html';
            } else {
                alert('Error: ' + result.message);
            }
        }

        loadFlight();
    </script>
</body>

</html>