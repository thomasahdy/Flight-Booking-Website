<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Tripma</title>
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <header class="header">
        <nav class="navbar">
            <a href="#" class="logo" onclick="goHome()">Tripma</a>
            <ul class="nav-links">
                <li><a href="#" onclick="goHome()">Home</a></li>
                <li><a href="messages.html">Messages</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container" style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
        <div>
            <h3>Conversations</h3>
            <div id="conversations">
                <p>Loading...</p>
            </div>
        </div>
        <div>
            <h3 id="chatTitle">Select a conversation</h3>
            <div id="messages"
                style="min-height: 400px; max-height: 500px; overflow-y: auto; border: 1px solid var(--gray-light); padding: 1rem; margin-bottom: 1rem;">
                <p style="text-align: center; color: var(--gray-medium);">Select a conversation to view messages</p>
            </div>
            <div id="messageForm" style="display: none;">
                <textarea id="newMessage" placeholder="Type your message..."
                    style="width: 100%; min-height: 80px; padding: 0.5rem;"></textarea>
                <button onclick="sendMessage()" class="btn btn-primary" style="margin-top: 0.5rem;">Send</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const user = checkAuth();
        let currentChat = null;

        function goHome() {
            window.location.href = user.type === 'company' ? 'company-home.html' : 'passenger-home.html';
        }

        async function loadConversations() {
            const result = await apiCall('messages/get-messages.php');
            if (result.success) {
                displayConversations(result.conversations);
            }
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversations');

            if (conversations.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-medium);">No messages yet</p>';
                return;
            }

            container.innerHTML = conversations.map(conv => `
                <div class="card" onclick="loadChat(${conv.other_user_id}, '${conv.other_user_name}')" style="cursor: pointer; margin-bottom: 1rem;">
                    <h4>${conv.other_user_name}</h4>
                    <p style="color: var(--gray-medium); font-size: 0.875rem;">${conv.other_user_type}</p>
                    <p style="color: var(--gray-medium); font-size: 0.875rem; margin-top: 0.5rem;">${conv.last_message ? conv.last_message.substring(0, 50) + '...' : 'No messages'}</p>
                </div>
            `).join('');
        }

        async function loadChat(userId, userName) {
            currentChat = userId;
            document.getElementById('chatTitle').textContent = 'Chat with ' + userName;
            document.getElementById('messageForm').style.display = 'block';

            const result = await apiCall('messages/get-messages.php?with=' + userId);
            if (result.success) {
                displayMessages(result.messages);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages');

            if (messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--gray-medium);">No messages yet. Start the conversation!</p>';
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: ${msg.sender_id == user.id ? 'var(--primary-purple)' : 'var(--gray-light)'}; color: ${msg.sender_id == user.id ? 'white' : 'black'}; border-radius: 8px; max-width: 70%; ${msg.sender_id == user.id ? 'margin-left: auto;' : ''}">
                    <p style="margin: 0; font-size: 0.875rem; opacity: 0.8;">${msg.sender_name}</p>
                    <p style="margin: 0.5rem 0 0 0;">${msg.message}</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; opacity: 0.7;">${formatDate(msg.created_at)}</p>
                </div>
            `).join('');

            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const message = document.getElementById('newMessage').value;
            if (!message || !currentChat) return;

            const result = await apiCall('messages/send-message.php', 'POST', {
                receiver_id: currentChat,
                message: message
            });

            if (result.success) {
                document.getElementById('newMessage').value = '';
                loadChat(currentChat, document.getElementById('chatTitle').textContent.replace('Chat with ', ''));
            } else {
                alert('Error: ' + result.message);
            }
        }

        loadConversations();
    </script>
</body>

</html>